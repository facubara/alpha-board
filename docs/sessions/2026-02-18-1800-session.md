# Session: 2026-02-18 18:00

**Goal**: Implement tweet relevance filter (keyword + LLM fallback) for Twitter ingestion pipeline
**Agent Roles**: Implementation (worker backend feature)

## Model Settings

| Setting | Value | Description |
|---------|-------|-------------|
| Subagent Model | `inherit` | Model for subagent tasks |

---

## Work Summary

Implemented a two-tier tweet relevance filter at ingestion time. Tier 1 is a free keyword/regex heuristic check matching ~120 crypto/trading/market terms, ticker patterns ($BTC, BTCUSDT), and price patterns ($42,000, 15%, 10x). Tier 2 is a cheap Claude Haiku yes/no call (~$0.0001/tweet) for ambiguous tweets. Irrelevant tweets (personal updates, unrelated promos) are discarded before hitting the DB. Gated by two switches: `TWEET_FILTER_ENABLED` env var (master) and `tweet_relevance_filter` llm_settings toggle (LLM fallback only).

## Files Changed

### Created
- `worker/src/twitter/filter.py` — `TweetRelevanceFilter` class with `is_relevant()` keyword filter, `check_relevance_llm()` Haiku fallback, and `filter_tweets()` batch entry point
- `worker/alembic/versions/020_tweet_relevance_filter_setting.py` — Insert `tweet_relevance_filter` row into `llm_settings` table

### Modified
- `worker/src/config.py` — Added `tweet_filter_enabled: bool = False` feature flag
- `worker/src/twitter/poller.py` — Added filter step between tweet fetch and DB persist; filter stats included in poll response summary
- `worker/src/main.py` — Added `load_llm_settings()` calls in `run_twitter_poll()` and `trigger_twitter()` to populate settings cache before poll
- `next-steps.md` — Added feature #23 (Tweet Relevance Filter) as COMPLETED

### Deleted
- (none)

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Two-gate design | Env var (master) + DB toggle (LLM only) | Allows keyword-only filtering without LLM cost; full disable for rollback |
| Fail-open on ambiguous | Keep tweet if LLM disabled or errors | Better to analyze an irrelevant tweet than miss a relevant one |
| No soft-delete | Discard filtered tweets entirely | Simpler; irrelevant tweets have no value to preserve |
| Term set size | ~120 terms across 3 categories | Comprehensive enough to catch most crypto tweets; small enough for fast matching |
| LLM model | Reuse `tweet_analysis_model` (Haiku 4.5) | Consistent with existing tweet analysis; cheapest option |

## Security Checklist

- [x] No hardcoded secrets (API keys, passwords, tokens)
- [x] No proprietary algorithms exposed
- [x] Environment variables used for configuration

## Commit Message

```
feat(worker): add two-tier tweet relevance filter (keyword + LLM fallback)

- Created TweetRelevanceFilter with ~120 crypto/trading term heuristics
- Added Haiku LLM fallback for ambiguous tweets (~$0.0001/tweet)
- Migration 020 adds tweet_relevance_filter to llm_settings
- Two-gate design: TWEET_FILTER_ENABLED env var + DB toggle
- Filter stats included in poll response

Session: docs/sessions/2026-02-18-1800-session.md
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

## Next Steps

- [ ] Monitor filter stats over a few poll cycles to tune term sets
- [ ] Consider adding a `/twitter/filter-test` debug endpoint to test filter on arbitrary text
- [ ] Track filter drop rate in analytics/status page

## Notes

Verified on production:
- Worker deployed to Fly.io, migration 020 applied (head)
- `TWEET_FILTER_ENABLED=true` env var set
- Poll triggered successfully (0 new tweets at that moment, no errors)
- Settings page shows "Tweet Relevance Filter (LLM)" toggle (enabled, $0.00 cost)
- Tweet feed displays normally with existing tweets

Looking at the current feed, many tweets would be filtered: "I'm dead", "For those who like cigars", "chocolate is something else", "Fork's in Italy", "Happy New Year", "RIP Robert Duvall" — these will be dropped on future polls.

---
*Session ended: 2026-02-18*
