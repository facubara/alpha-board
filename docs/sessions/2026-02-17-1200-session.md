# Session: 2026-02-17 12:00

**Goal**: Implement Feature #13 — Smart Pruning (Symbol List Limit & Agent Auto-Discard)
**Agent Roles**: Implementation (full-stack)

## Model Settings

| Setting | Value | Description |
|---------|-------|-------------|
| Subagent Model | `inherit` | Model for subagent tasks |

---

## Work Summary

Implemented both parts of Feature #13. 13a caps the pipeline to the top 100 symbols by 24h volume (configurable via `TOP_SYMBOLS_LIMIT` env var). 13b adds a composite health score (drawdown 60% weight, win rate 40% weight) that auto-discards agents scoring below 30/100 after 20+ trades. Discarded agents appear in a collapsible section on the agents page with re-activate and permanent delete actions.

## Files Changed

### Created
- `worker/alembic/versions/015_agent_pruning.py` — Migration: discarded_at, discard_reason columns, widen status to varchar(20)
- `web/src/components/agents/discarded-agents.tsx` — Collapsible discarded agents table with re-activate/delete buttons
- `web/src/app/api/agents/[agentId]/reactivate/route.ts` — POST endpoint to re-activate discarded agent
- `web/src/app/api/agents/[agentId]/delete/route.ts` — DELETE endpoint to permanently remove agent

### Modified
- `worker/src/config.py` — Added `top_symbols_limit` setting (default 100)
- `worker/src/pipeline/runner.py` — Accept and apply `top_symbols_limit` param, slice symbols after fetch
- `worker/src/main.py` — Pass `top_symbols_limit` from settings to PipelineRunner
- `worker/src/models/db.py` — Added `discarded_at`, `discard_reason` columns; widened status to String(20)
- `worker/src/agents/orchestrator.py` — Added `_evaluate_agent_health()` method with composite score; called after trades close
- `web/src/lib/types.ts` — Added "discarded" to AgentStatus; added discardedAt/discardReason to interfaces
- `web/src/lib/queries/agents.ts` — Exclude discarded from leaderboard; added getDiscardedAgents, reactivateAgent, deleteAgent; guarded toggleAgentStatus
- `web/src/app/agents/page.tsx` — Fetch and render discarded agents section
- `web/src/components/agents/index.ts` — Export DiscardedAgents component
- `next-steps.md` — Marked Feature #13 as COMPLETED
- `docs/PROGRESS.md` — Added Feature #13 to progress tracker

### Deleted
- (none)

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Symbol limit default | 100 | Covers all meaningful volume; reduces pipeline time for lower timeframes |
| Composite score weights | Drawdown 60%, win rate 40% | Drawdown is the primary risk signal; win rate is secondary |
| Health threshold | 30/100 | Conservative — only discards truly poor performers |
| Min trades gate | 20 | Ensures statistical significance before evaluation |
| Discard UX | Collapsible section (not tab) | Low priority content; doesn't clutter main view |
| Delete cascade | Manual SQL cascade | Safe deletion order respecting FK constraints |

## Security Checklist

- [x] No hardcoded secrets (API keys, passwords, tokens)
- [x] All data is synthetic (no real customer/company data)
- [x] No proprietary algorithms exposed (using stubs)
- [x] Environment variables used for configuration

## Commit Message

```
feat: add smart pruning — symbol limit & agent auto-discard (#13)

- 13a: TOP_SYMBOLS_LIMIT config caps pipeline to top N symbols by volume (default 100)
- 13b: Composite health score (drawdown 60%, win rate 40%) auto-discards agents below threshold
- Migration 015: discarded_at, discard_reason columns on agents table
- Discarded agents section on /agents page with re-activate and delete actions
- Guard toggleAgentStatus from accidentally re-activating discarded agents

Session: docs/sessions/2026-02-17-1200-session.md
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

## Next Steps

- [ ] Monitor auto-discard behavior over next few days as agents accumulate trades
- [ ] Consider adding pruning thresholds as configurable via env vars
- [ ] Consider notification when agent is auto-discarded

## Notes

Symbol pruning is immediately visible in /health endpoint — 15m/30m/1h timeframes now capped at 100 symbols (previously 150+). Agent auto-discard requires 20+ trades before activation, so no agents discarded yet. The "Discarded Agents" section will appear once the first agent gets discarded.

---
*Session ended: 2026-02-17 13:35*
